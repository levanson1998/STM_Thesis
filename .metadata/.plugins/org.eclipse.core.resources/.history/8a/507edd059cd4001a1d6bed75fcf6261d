/*
 * pid_controller.c
 *
 *  Created on: Jul 23, 2020
 *      Author: Son
 */

#include <pid_controller.h>
#include "math.h"

//volatile float PID_in[2];
float PID_out[2];
//float PID_P[2], PID_I[2], PID_D[2];
float PID_Kp[2], PID_Ki[2], PID_Kd[2];
float PID_Test[10];
float PID_pre_err[2], PID_ppre_err[2];
float PID_out_max=299.0f, PID_out_min=0.0f, PID_T;
float PID1[2];

float error, PID_P[2], PID_I[2], PID_D[2];
float A0, A1, A2, Aout, Aout1, E0, E1, E2;

void PID_Init(float *Kp, float *Ki, float *Kd, float Ts) {
	for (int i = 0; i < 2; i++) {
		PID_Kp[i] = *(Kp+i);
		PID_Ki[i] = *(Ki+i);
		PID_Kd[i] = *(Kd+i);
	}
	PID_T = Ts/1000.0f;
}

float * PID_Calculate(float *PID_in, float *PID_current){
//	float error, PID_P, PID_I, PID_D;
//	volatile float PID_out[2];
	PID_Test[2] = *(PID_current);
/*
	for (int i=0;i<2; i++){
		PID_Test[i]=*(PID_in+i);
		error = (*(PID_current+i)-*(PID_in+i))*enc[i*2+1];
		PID_P[i] = (float)(PID_Kp[i]*(error-PID_pre_err[i]));
		PID_I[i] = -(float)(0.5F*PID_Ki[i]*0.005f*(error+PID_pre_err[i]));
		PID_D[i] = (float)(PID_Kd[i]*200.0f*(error-2.0f*PID_pre_err[i]+PID_ppre_err[i]));

		PID_out[i] = (PID_P[i] + PID_I[i] + PID_D[i]) + PID_out[i];

		if (PID_out[i]>PID_out_max){
			PID_out[i]=PID_out_max;
		}
		else if (PID_out[i]<PID_out_min){
			PID_out[i]=PID_out_min;
		}
		PID1[i] = PID_out[i];
		PID_ppre_err[i]=PID_pre_err[i];
		PID_pre_err[i]=error;
	}
*/
	E0 = 10.0F - *PID_current;
	A0 = PID_Kp + PID_Ki*PID_T/2.0F + PID_Kd/PID_T;
	A1 = -PID_Kp + PID_Ki*PID_T/2.0F - 2.0F*PID_Kd/PID_T;
	A2 = PID_Kd/PID_T;
	Aout = A0*E0 + A1*E1 + A2*E2;
	Aout1 = Aout;
	E1 = E;
	E2 = E1;

//	PID_Test[5] += PID_out[0];
	return PID_out;
}

